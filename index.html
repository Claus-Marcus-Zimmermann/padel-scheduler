<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Padel Doubles Scheduler</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
}
.container {
    max-width: 800px;
    margin: auto;
    padding: 20px;
}
h1 {
    text-align: center;
}
.section {
    margin-bottom: 20px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
}
label {
    display: block;
    margin-top: 6px;
}
input[type="text"],
input[type="number"],
input[type="time"] {
    width: 100%;
    padding: 6px;
    margin-top: 2px;
}
button {
    margin-top: 10px;
    padding: 8px 16px;
}
.player-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
}
.history-table {
    width: 100%;
    border-collapse: collapse;
}
.history-table th,
.history-table td {
    padding: 6px;
    border: 1px solid #ccc;
}
.round-display {
    background: #e6f7ff;
    padding: 10px;
    border-radius: 6px;
}
.small-note {
    font-size: 12px;
    opacity: 0.7;
}
</style>
</head>

<body>
<div class="container">
<h1>Padel Doubles Scheduler</h1>

<div class="section">
<h2>Players</h2>
<input id="playerName" placeholder="Player name">
<button onclick="addPlayer()">Add</button>
<ul id="playerList"></ul>
</div>

<div class="section">
<h2>Settings</h2>

<label>Start time</label>
<input type="time" id="startTime">

<label>Game duration (min)</label>
<input type="number" id="gameDuration" value="20">

<label>Changeover (min)</label>
<input type="number" id="changeoverDuration" value="5">

<label>
<input type="radio" name="mode" value="fun" checked> Fun random
</label>
<label>
<input type="radio" name="mode" value="fair"> Fair random
</label>

<div class="small-note">
Start time is used only for the <b>first round of a session</b>.  
Changing it backwards starts a <b>new session</b>.
</div>
</div>

<div class="section">
<button onclick="generateRound()">Generate Next Round</button>
<div id="currentRound" class="round-display" style="display:none"></div>
</div>

<div class="section">
<h2>History</h2>
<table class="history-table">
<thead>
<tr>
<th>Session</th>
<th>Round</th>
<th>Date</th>
<th>Start</th>
<th>End</th>
<th>Team A</th>
<th>Team B</th>
<th>Sat out</th>
<th></th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
</div>
</div>

<script>
const KEY_PLAYERS = "padel_players";
const KEY_HISTORY = "padel_history";
const KEY_PREFS = "padel_prefs";

let players = JSON.parse(localStorage.getItem(KEY_PLAYERS) || "[]");
let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");

let prefs = JSON.parse(localStorage.getItem(KEY_PREFS) || "{}");
prefs.startTime ??= next5Min();
prefs.gameDuration ??= 20;
prefs.changeoverDuration ??= 5;

let lastStart = history.length ? new Date(history.at(-1).start) : null;
let lastEnd   = history.length ? new Date(history.at(-1).end) : null;
let currentSession = history.length ? history.at(-1).session : 1;

document.getElementById("startTime").value = prefs.startTime;
document.getElementById("gameDuration").value = prefs.gameDuration;
document.getElementById("changeoverDuration").value = prefs.changeoverDuration;

renderPlayers();
renderHistory();

function addPlayer() {
    const name = playerName.value.trim();
    if (!name || players.includes(name)) return;
    players.push(name);
    save();
    renderPlayers();
}

function generateRound() {
    if (players.length < 4) return alert("Need at least 4 players");

    const startSetting = startTime.value || prefs.startTime;
    prefs.startTime = startSetting;
    prefs.gameDuration = +gameDuration.value;
    prefs.changeoverDuration = +changeoverDuration.value;
    localStorage.setItem(KEY_PREFS, JSON.stringify(prefs));

    const baseStart = combineToday(startSetting);
    let start;

    if (!lastStart || baseStart <= lastStart) {
        currentSession++;
        start = baseStart;
    } else {
        start = new Date(lastEnd.getTime() + prefs.changeoverDuration * 60000);
    }

    const end = new Date(start.getTime() + prefs.gameDuration * 60000);

    const shuffled = [...players].sort(() => Math.random() - 0.5);
    const teamA = shuffled.slice(0,2);
    const teamB = shuffled.slice(2,4);
    const sat   = shuffled.slice(4);

    const roundNo = history.filter(h => h.session === currentSession).length + 1;

    history.push({
        session: currentSession,
        round: roundNo,
        start,
        end,
        teamA,
        teamB,
        sat
    });

    lastStart = start;
    lastEnd = end;

    save();
    renderHistory();
    showCurrent(start, end, teamA, teamB, sat);
}

function renderPlayers() {
    playerList.innerHTML = "";
    players.forEach(p => {
        const li = document.createElement("li");
        li.className = "player-item";
        li.innerHTML = `${p} <button onclick="removePlayer('${p}')">x</button>`;
        playerList.appendChild(li);
    });
}

function renderHistory() {
    historyBody.innerHTML = "";
    history
      .slice()
      .sort((a,b)=>b.start-a.start)
      .forEach((h,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${h.session}</td>
        <td>${h.round}</td>
        <td>${fmtDate(h.start)}</td>
        <td>${fmtTime(h.start)}</td>
        <td>${fmtTime(h.end)}</td>
        <td>${h.teamA.join(" & ")}</td>
        <td>${h.teamB.join(" & ")}</td>
        <td>${h.sat.join(", ")}</td>
        <td>${i===0?'<button onclick="deleteLast()">Delete</button>':''}</td>`;
        historyBody.appendChild(tr);
      });
}

function deleteLast() {
    history.pop();
    save();
    location.reload();
}

function showCurrent(s,e,a,b,so) {
    currentRound.style.display="block";
    currentRound.innerHTML=`
    <b>${fmtDate(s)}</b><br>
    ${fmtTime(s)} - ${fmtTime(e)}<br>
    Team A: ${a.join(" & ")}<br>
    Team B: ${b.join(" & ")}<br>
    Sat out: ${so.join(", ")}`;
}

function save(){
    localStorage.setItem(KEY_PLAYERS, JSON.stringify(players));
    localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
}

function removePlayer(p){
    players = players.filter(x=>x!==p);
    save();
    renderPlayers();
}

function fmtTime(d){return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
function fmtDate(d){return d.toLocaleDateString("en-GB")}
function combineToday(hm){
    const [h,m]=hm.split(":");
    const d=new Date(); d.setHours(h,m,0,0); return d;
}
function next5Min(){
    const d=new Date(); d.setMinutes(Math.ceil(d.getMinutes()/5)*5,0,0);
    return fmtTime(d);
}
</script>
</body>
</html>
